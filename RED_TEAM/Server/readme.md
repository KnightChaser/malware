# Keylogging Malware Server

## 기능 요약

이 서버는 여러 클라이언트로부터 키로깅 데이터를 수집하고 안전하게 저장하는 악성코드 서버로 설계되었다. 이 서버는 다음과 같은 기능을 지원한다:

1. **암호화된 통신**: 서버는 RSA와 AES 암호화를 사용하여 클라이언트와 안전하게 데이터를 주고받는다.
2. **다중 클라이언트 지원**: 서버는 여러 클라이언트가 동시에 접속하여 데이터를 전송할 수 있도록 스레드를 통해 각 클라이언트를 개별적으로 처리한다.
3. **데이터베이스 저장**: 수신된 키로깅 데이터를 MariaDB에 저장하여 각 클라이언트의 키 입력 기록을 보관한다.
4. **실시간 상태 로그**: 서버는 클라이언트의 연결 상태와 데이터 수신 여부를 실시간으로 콘솔에 출력한다.

---

## 서버 디렉토리 구성 및 설명

### 1. **Server.py**
- 서버의 메인 코드로, 여러 클라이언트로부터 암호화된 키로깅 데이터를 수신하여 복호화하고 이를 MariaDB에 저장하는 기능을 담당한다.
- 클라이언트와의 연결을 수락하고, 각 클라이언트의 세션을 처리하는 스레드를 생성한다.
- RSA 및 AES 암호화를 처리하고, 수신된 데이터를 MariaDB에 기록한다.

### 2. **Client.py**
- 서버에 데이터를 전송하는 클라이언트 코드이다.
- 서버로부터 RSA 공개키를 수신하고, AES 키를 암호화하여 서버에 전송한다.
- 텍스트 또는 파일 데이터를 AES로 암호화하여 서버에 보내고, 서버의 응답을 처리한다.

### 3. **ProtocolMessage.py**
- 서버와 클라이언트 간의 데이터를 안전하게 전송하기 위한 메시지 형식을 정의한 코드이다.
- 데이터 직렬화 및 역직렬화, AES 암호화 및 복호화, 패딩 추가 및 랜덤 데이터 삽입 등을 처리한다.
- 메시지의 타입과 데이터를 정의하고 암호화된 페이로드를 처리한다.

### 4. **init_db.sql**
- 데이터베이스를 초기화하는 SQL 스크립트이다.
- `messages` 테이블을 생성하고, 필요한 컬럼을 설정하여 서버가 데이터를 저장할 수 있도록 한다.
- `client_ip`, `client_port` 및 `message` 컬럼을 포함한 테이블을 설정하여 클라이언트의 IP, 포트 및 메시지를 저장한다.

### 5. **readme.md**
- 프로젝트에 대한 설명과 설정 방법, 실행 방법 등을 문서화한 파일이다.
- 서버와 클라이언트의 실행 방법, 데이터베이스 설정 방법 등을 포함하고 있다.

---

## 실행 방법

### 1. MariaDB 설치 및 설정
- MariaDB를 설치해야 한다. 설치 방법은 운영 체제에 따라 다를 수 있으니, [MariaDB 공식 문서](https://mariadb.org/download/)를 참조하여 MariaDB를 설치한다.
- 설치 후, MariaDB를 실행하고 데이터베이스와 테이블을 설정하기 위해 `init_db.sql` 파일을 실행한다.

```bash
-- MariaDB에 접속
mysql -u root -p

-- 데이터베이스 및 테이블 생성
source /path/to/init_db.sql;
```

이 과정이 끝나면 `test`라는 데이터베이스가 생성되고, `messages` 테이블이 포함된다.

### 2. 서버 실행
- `Server.py` 파일이 있는 디렉토리에서 서버를 실행한다.

```bash
python Server.py
```

서버가 실행되면 다음과 같은 메시지가 출력된다:

```
Server running on localhost:12345
```

### 3. 클라이언트 실행
- `Client.py` 파일을 실행하여 서버에 데이터를 전송한다.

```bash
python Client.py
```

서버는 클라이언트와 연결된 후 메시지를 수신하고, 받은 데이터를 처리하여 MariaDB에 저장한다.

### 4. 동시 클라이언트 연결
- 서버는 여러 클라이언트와 동시에 연결하여 데이터를 처리할 수 있다. 클라이언트가 여러 개의 세션을 통해 데이터를 전송하면, 서버는 이를 처리하고 응답을 보낸다.
- 서버는 각 클라이언트의 데이터를 독립적으로 처리하며, MAC 체크 및 AES 복호화 문제를 처리한다.

---

## 코드 실행을 위한 환경 설정

### 1. Python 버전
- 이 코드는 Python 3.6 이상에서 실행된다. Python 버전을 확인하고 필요한 경우 최신 버전으로 업데이트한다.

```bash
python --version
```

### 2. 필요한 라이브러리 설치
- 필요한 라이브러리를 `requirements.txt` 파일을 통해 설치할 수 있다. `requirements.txt` 파일에 다음과 같은 라이브러리가 포함되어 있다.

```txt
pycryptodome==3.10.1
cryptography==39.0.1
mysql-connector-python==8.0.29
```

라이브러리 설치는 다음과 같이 진행한다:

```bash
pip install -r requirements.txt
```

### 3. MariaDB 설정
- MariaDB가 설치되어 있어야 하며, 데이터베이스와 테이블이 `init_db.sql`에 따라 설정되어 있어야 한다. 위에서 설명한대로 SQL 스크립트를 사용하여 데이터베이스와 테이블을 생성한다.

### 4. 실행 시 발생하는 문제 해결
- **"MAC check failed" 오류**: 이 오류는 데이터의 무결성 확인에 실패했을 때 발생한다. 서버와 클라이언트가 동일한 암호화 키를 사용해야 하며, 각 클라이언트와 서버 간의 AES 키와 IV 설정이 정확해야 한다. 이 오류가 발생하면 키나 IV가 잘못된 경우가 많으므로 이를 확인해야 한다.
- **서버 연결 오류**: 서버가 제대로 실행되지 않으면 클라이언트가 연결할 수 없다. 서버가 실행 중인지 확인하고, 방화벽이나 포트 설정도 확인해야 한다.

### 5. 디버깅
- 코드에서 오류가 발생하면, `print` 문을 사용하여 디버깅 로그를 추가하여 데이터 흐름을 추적할 수 있다. 예를 들어, 데이터베이스 연결 성공 여부, 데이터 수신 및 전송 상태 등을 출력하여 문제를 추적할 수 있다.

---

## 사용 예시

1. **서버 실행**:
    ```bash
    python Server.py
    ```

2. **클라이언트 실행**:
    ```bash
    python Client.py
    ```


## 실행 예시
1. **서버 측**:
    ```bash
    PS C:\Users\woojin\Desktop\Malware\RED_TEAM\Server> python .\Server.py
Server running on localhost:12345
Client connected: ('127.0.0.1', 62912) (Session ID: 422e7561)
Client connected: ('127.0.0.1', 62914) (Session ID: 0ea08b86)
Client connected: ('127.0.0.1', 62916) (Session ID: ffba18e5)
Received keylog data from client ('127.0.0.1', 62914) (Session ID: 0ea08b86): hello1
Received keylog data from client ('127.0.0.1', 62916) (Session ID: ffba18e5): hello2
Received keylog data from client ('127.0.0.1', 62912) (Session ID: 422e7561): hello3
Received keylog data from client ('127.0.0.1', 62914) (Session ID: 0ea08b86): HELLO1
Received keylog data from client ('127.0.0.1', 62912) (Session ID: 422e7561): HELLO3
Received keylog data from client ('127.0.0.1', 62916) (Session ID: ffba18e5): HELLO2
Received keylog data from client ('127.0.0.1', 62914) (Session ID: 0ea08b86): test1
Received keylog data from client ('127.0.0.1', 62916) (Session ID: ffba18e5): test2
Received keylog data from client ('127.0.0.1', 62912) (Session ID: 422e7561): test3
Client disconnected: (Session ID: 422e7561)
Connection closed (Session ID: 422e7561)
Received keylog data from client ('127.0.0.1', 62916) (Session ID: ffba18e5): TEST2
Client disconnected: (Session ID: ffba18e5)
Connection closed (Session ID: ffba18e5)
Received keylog data from client ('127.0.0.1', 62914) (Session ID: 0ea08b86): TEST1
Received keylog data from client ('127.0.0.1', 62914) (Session ID: 0ea08b86): TERMINATE
Client disconnected: (Session ID: 0ea08b86)
Connection closed (Session ID: 0ea08b86)
    ```

2. **클라이언트 측**:
    ```bash
PS C:\Users\woojin\Desktop\Malware\RED_TEAM\Server> python .\Client.py
Enter message to send to server: hello1
Response from server: Data received from session 0ea08b86.
Enter message to send to server: HELLO1
Response from server: Data received from session 0ea08b86.
Enter message to send to server: test1
Response from server: Data received from session 0ea08b86.
Enter message to send to server: TEST1
Response from server: Data received from session 0ea08b86.
Enter message to send to server: TERMINATE
Response from server: Data received from session 0ea08b86.
Enter message to send to server: Traceback (most recent call last):
  File "C:\Users\woojin\Desktop\Malware\RED_TEAM\Server\Client.py", line 38, in <module>
    message = input("Enter message to send to server: ")
KeyboardInterrupt

PS C:\Users\woojin\Desktop\Malware\RED_TEAM\Server> python .\Client.py
Enter message to send to server: hello2
Response from server: Data received from session ffba18e5.
Enter message to send to server: HELLO2
Response from server: Data received from session ffba18e5.
Enter message to send to server: test2
Response from server: Data received from session ffba18e5.
Enter message to send to server: TEST2
Response from server: Data received from session ffba18e5.
Enter message to send to server: Traceback (most recent call last):
  File "C:\Users\woojin\Desktop\Malware\RED_TEAM\Server\Client.py", line 38, in <module>
    message = input("Enter message to send to server: ")
KeyboardInterrupt

    PS C:\Users\woojin\Desktop\Malware\RED_TEAM\Server> python .\Client.py
Enter message to send to server: hello3
Response from server: Data received from session 422e7561.
Enter message to send to server: HELLO3
Response from server: Data received from session 422e7561.
Enter message to send to server: test3
Response from server: Data received from session 422e7561.
Enter message to send to server: Traceback (most recent call last):
  File "C:\Users\woojin\Desktop\Malware\RED_TEAM\Server\Client.py", line 38, in <module>
    message = input("Enter message to send to server: ")
KeyboardInterrupt
    ```

3. **DB 측**:
MariaDB [test]> SELECT * FROM keylogs;
+----+------------+-----------+-----------+-------------+---------------------+
| id | session_id | message   | client_ip | client_port | created_at          |
+----+------------+-----------+-----------+-------------+---------------------+
| 35 | 0ea08b86   | hello1    | 127.0.0.1 |       62914 | 2024-11-15 02:58:27 |
| 36 | ffba18e5   | hello2    | 127.0.0.1 |       62916 | 2024-11-15 02:58:31 |
| 37 | 422e7561   | hello3    | 127.0.0.1 |       62912 | 2024-11-15 02:58:37 |
| 38 | 0ea08b86   | HELLO1    | 127.0.0.1 |       62914 | 2024-11-15 02:58:44 |
| 39 | 422e7561   | HELLO3    | 127.0.0.1 |       62912 | 2024-11-15 02:58:47 |
| 40 | ffba18e5   | HELLO2    | 127.0.0.1 |       62916 | 2024-11-15 02:58:55 |
| 41 | 0ea08b86   | test1     | 127.0.0.1 |       62914 | 2024-11-15 02:59:00 |
| 42 | ffba18e5   | test2     | 127.0.0.1 |       62916 | 2024-11-15 02:59:05 |
| 43 | 422e7561   | test3     | 127.0.0.1 |       62912 | 2024-11-15 02:59:08 |
| 44 | ffba18e5   | TEST2     | 127.0.0.1 |       62916 | 2024-11-15 02:59:19 |
| 45 | 0ea08b86   | TEST1     | 127.0.0.1 |       62914 | 2024-11-15 02:59:26 |
| 46 | 0ea08b86   | TERMINATE | 127.0.0.1 |       62914 | 2024-11-15 02:59:33 |
+----+------------+-----------+-----------+-------------+---------------------+
12 rows in set (0.007 sec)

**DB 구조**
MariaDB [test]> DESCRIBE keylogs;
+-------------+-------------+------+-----+---------------------+----------------+
| Field       | Type        | Null | Key | Default             | Extra          |
+-------------+-------------+------+-----+---------------------+----------------+
| id          | int(11)     | NO   | PRI | NULL                | auto_increment |
| session_id  | varchar(8)  | NO   |     | NULL                |                |
| message     | text        | YES  |     | NULL                |                |
| client_ip   | varchar(45) | YES  |     | NULL                |                |
| client_port | int(11)     | YES  |     | NULL                |                |
| created_at  | timestamp   | YES  |     | current_timestamp() |                |
+-------------+-------------+------+-----+---------------------+----------------+
6 rows in set (0.062 sec)
서버는 클라이언트로부터 키로깅 데이터를 수신하고, 이를 데이터베이스에 저장한다.